
# 任务统计逻辑分析

## task-stats-card.tsx 中的筛选和统计逻辑

### 时间范围筛选

1. **今日（today）**
   - 范围：从当天 00:00:00 到 23:59:59
   - 使用 `startOfDay(today)` 和 `endOfDay(today)` 计算范围

2. **本周（week）**
   - 范围：从本周一 00:00:00 到周日 23:59:59
   - 使用 `startOfWeek(today, { weekStartsOn: 1 })` 和 `endOfWeek(today, { weekStartsOn: 1 })`

3. **本月（month）**
   - 范围：从本月 1 日 00:00:00 到月末 23:59:59
   - 使用 `startOfMonth(today)` 和 `endOfMonth(today)`

4. **全部（all）**
   - 不限定时间范围
   - 使用 `new Date(0)` 和 `new Date(8640000000000000)`（最大日期）

### 任务统计指标

1. **总任务（total）**
   - 统计时间范围内的所有非删除任务
   - 包括所有任务类别（next_action、someday_maybe、waiting_for）
   - 对于非重复任务：检查计划日期或截止日期是否符合范围
   - 对于重复任务：检查是否有重复实例在时间范围内

2. **下一步（nextAction）**
   - 符合时间范围内且 category = "next_action" 的任务总数
   - 包括已完成和未完成的任务

3. **进行中（inProgress）**
   - 时间范围内且 category = "next_action" 的任务
   - 未完成（completed = 0）
   - 没有过期（dueDate 未到或未设置）

4. **已过期（overdue）**
   - 时间范围内且 category = "next_action" 的任务
   - 未完成（completed = 0）
   - 已过期（dueDate 已经到期或者等于当天）

5. **已完成（completedInRange）**
   - 时间范围内已完成的任务
   - completed = 1 且 completedAt 在选定的时间范围内

6. **重复（recurring）**
   - 时间范围内且 isRecurring = 1 的任务总数

### 重复任务处理

重复任务的判断逻辑通过 `isRecurringTaskOccurringInDateRange` 函数实现：

```javascript
const isRecurringTaskOccurringInDateRange = (task, checkRangeStart, checkRangeEnd)
```

这个函数判断一个重复任务是否在指定日期范围内有实例：

1. 解析任务的recurrenceRule（可能是字符串或对象）
2. 根据plannedDate确定起始日期
3. 使用RRule库计算是否有重复实例落在指定范围内

## TodayFocusTasks.tsx 中的筛选逻辑

TodayFocusTasks组件通过选项卡显示不同类别的今日任务。每个选项卡的筛选逻辑如下：

1. **进行中（inProgress）**
   - 条件：
     - category = "next_action"
     - 未完成（completed = false）
     - 计划日期（plannedDate）小于等于今天
     - 截止日期（dueDate）大于今天或不存在

2. **到期任务（due）**
   - 条件：
     - category = "next_action"
     - 未完成（completed = false）
     - 截止日期（dueDate）小于等于今天

3. **已完成（completedToday）**
   - 条件：
     - category = "next_action"
     - 已完成（completed = true）
     - completedAt 是今天

4. **即将开始（upcomingPlanned）**
   - 条件：
     - category = "next_action"
     - 未完成（completed = false）
     - 计划日期（plannedDate）在明天到三天后之间

5. **即将到期（dueSoon）**
   - 条件：
     - category = "next_action"
     - 未完成（completed = false）
     - 截止日期（dueDate）在明天到三天后之间

### 排序逻辑

任务的排序规则为：
1. 青蛙任务优先（isFrog）
2. 然后按优先级排序
3. 最后按日期排序（已完成任务按完成日期降序，其他任务按相关日期升序）

## 两个组件的区别

1. **数据来源**：
   - task-stats-card 通过 useTaskStats 从 task-stats-updater 获取预计算的统计数据
   - TodayFocusTasks 直接从数据库获取任务，然后在组件内进行筛选

2. **筛选粒度**：
   - task-stats-card 包含所有任务类别的统计
   - TodayFocusTasks 只筛选 category = "next_action" 的任务

3. **时间范围**：
   - task-stats-card 支持切换时间范围（今日、本周、本月、全部）
   - TodayFocusTasks 固定为今天及其周围日期（即将到期、即将开始）
   
4. **重复任务处理**：
   - task-stats-card 通过计算重复规则判断任务是否在时间范围内
   - TodayFocusTasks 不特殊处理重复任务，只根据plannedDate和dueDate决定显示时间
